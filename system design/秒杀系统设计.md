## 涉及到技术点
### 数据库层面
#### Redis 分布式锁
#### 缓存预热
#### 数据库乐观锁
#### 数据库索引优化
### 中间件
#### 消息队列
#### 延迟队列
#### 接口限流
#### 服务熔断
### 优化
#### 商品限购
#### 雪花算法
#### 分布式事务
#### 页面静态化
#### JMeter 压力测试
#### 防爬虫和黄牛请求

## 场景
### 功能需求
#### 运营
- 创建秒杀活动
- 关联秒杀商品
#### 客户
- 查看活动首页
- 查看活动页
- 下单
- 支付
### 非功能需求
QPS - 100万-瞬时流量
需要明确：MySQL 单机QPS 1000 
单个web service QPS 1000
100万 QPS的意思就是说web service 需要至少1000台，同时考虑到秒杀服务本身涉及到的数据量非常少，但是MySQL本身的QPS很低，不适合分库分散QPS压力的场景，需要借助缓存服务器，例如Redis等，Redis 单机的QPS的10万，需要QPS的从库来分散读压力，10台Redis从库就能承担100万QPS的压力。

---- 
## service 服务划分
### 需要提供哪些服务？
#### 秒杀运营管理服务
- 创建秒杀活动
	# 创建活动
	def createActivity():
		pass
- 关联商品信息
	# 关联商品信息
	def addProduct():
		pass
#### 商品服务
- 提供商品信息
- 商品详情信息
- 商品sku spu信息
#### 下单服务
- 库存操作
#### 支付服务
- 完成付款
## 数据库设计
秒杀相关服务的数据都是结构化的数据
可以采用MySQL存储
### MySQL Schema 设计
#### 秒杀活动表
活动ID / 活动名称/ 活动描述 / 创建时间 / 开始时间 / 结束时间 / 创建人 / 状态 / 审核人 /最后修改时间/ 
#### 活动商品表
活动ID / 商品ID/ 商品名称/ 库存 /  锁定库存 - 首页
#### 商品信息表
商品ID / 商品名称/ 商品描述/ 商品标题/ - 详情页需要
#### 订单表
订单ID/ 订单UID/ 用户ID / 用户名称 / 成交价格/ 活动ID / 商品ID/ 订单状态
### Redis 存储结构
库存信息 - 
商品信息 - 
活动商品信息 - 
订单信息 - 
## scale
### 优化思路总结


秒杀服务的特征总结：高并发的读写服务，但是数据规模不大。
1. 如何避免秒杀服务影响正常服务？
	> 把秒杀系统独立出来单独打造一个系统，这样可以有针对性地做优化；
	> 系统部署上也独立做一个机器集群，这样秒杀的大流量就不会影响到正常的商品购买集群的机器负载。
	> 将热点数据（如库存数据）单独放到一个缓存系统中，以提高“读性能”
2. 100万的QPS读首页和详情页，以目前的架构是无法承受的，怎么优化？
	方法论：提高单次请求的效率，减少不必要的请求。
	当前读取策略：读MySQL数据，返回前端，前端构造页面
	> 缓存- 缓存到Redis
	> 首页数据 + 详情页数据 缓存到Redis
	> > 优点：减少多个应用接入时使用 Cache 的成本
	> > 统一 Cache 的方案更易于维护，如后面加强监控、配置的自动化，只需要一套解决方案就行，统一起来维护升级也比较方便。
	> > 可以共享内存，最大化利用内存，不同系统之间的内存可以动态切换，从而能够有效应对各种攻击。
	> > 缺点：网卡 和 网络
	> > 单机宕机会影响部分缓存
	> 首页数据 + 详情页数据 缓存到CDN
	> > 缓存CDN中需要关注这几个问题。失效问题、命中率问题、发布更新问题，如何解决？所以放在全国所有节点不太现实，那就选择有限的节点：靠访问量比较集中的区域、离主站较远、节点到主站网络稳定、容量大—\> CDN二级缓存。
	> 动态数据 和 静态数据的分离
	> > 如何区分静态数据？
	> > > “动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和 URL、浏览者、时间、地域相关，以及是否含有 Cookie 等私密数据

3. 首页和详情页的倒计时怎么处理？
	> 放到前端处理，避免前端到后端频繁请求数据，前端拿到开始时间进行倒计时计算。同时，后端在进行请求处理时需要验证时间的有效性。
5. 如何处理秒杀器？（针对url的处理）
	> 答题器 + 限流
5. 各个服务的数据是分库还是同一个库？如果是分库，怎么保证各个库数据的一致性？
	> 只要求最终一致性，可以通过消息队列同步 + 重试机制。
	> 扩展：消息队列的重试机制是如何实现的？

6. 库存的正确性怎么保证？会存在哪些问题？怎么解决？
	扣库存的手段有三种：
	- 下单减库存
		- 优点：简单直接
		- 缺点：如果存在恶意刷单行为，会导致实际成交量为0
	- 付款减库存
		- 优点：保证成交量
		- 缺点：超卖
	- 下单预扣库存，付款减库存
		- 预扣库存，超时会自动释放库存，其他用户就可以继续购买。
		- 买家付款前。

7. 数据库和缓存数据什么时间同步？怎么同步？要同步哪些数据？
8. 防作弊优化手段有哪些？
3. 隐藏秒杀接口。
4. 同一个账号发出多个请求。前端：禁止重复提交；后端：Redis限流。
5. 多个账号一次性发出多个请求：一般这种请求都来自同一个 IP 地址，可以检测 IP 的请求频率，如果过于频繁则弹出一个验证码。
6. 多个账号不同 IP 发起不同请求：这种一般都是僵尸账号，检测账号的活跃度或者等级等信息，来进行限制。通过用户画像限制僵尸号无法参与秒杀或秒杀不能成功




