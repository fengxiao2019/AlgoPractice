# 概述
ZooKeeper支持客户端读取和更新具有高可用性的键值对。高可用性是通过将数据复制到多个节点并让客户端从任何节点读取来实现的。对Zookeeper的设计至关重要的是观察到每一个状态的变化都是相对于前一个状态的增量，所以对状态变化的顺序有一种隐性的依赖。Zookeeper原子广播（ZAB）是驱动ZooKeeper复制顺序保证的幕后协议。它还处理选举领导者和恢复失败的领导者和节点的问题。
定义
# 相关概念
领导者和跟随者
> 在ZooKeeper集群中，其中一个节点有一个领导者角色，其他节点有跟随者角色。领导负责接受所有来自客户端的状态变化，并将它们复制到自己和跟随者。
transactions
> 客户端的状态变化，领导者将其传播给跟随者。
epoch
> 是一个整数，由领导者开始领导时产生，应该大于以前领导者的epoch。
'c'
> 一个由领导者生成的序列号，从0开始并不断增加。它与纪元一起用于对进入的客户状态变化进行排序。
'F.history' 
> 跟随者的历史队列。用于按照传入事务的顺序来提交它们。
outstanding transactions
> F.history中序列号小于当前COMMIT序列号的事务集合。
# ZAB Requirements
- 客户端从任何一个ZooKeeper节点中读取。
- 客户端向任何一个ZooKeeper节点写入状态变化，这些状态变化被转发给领导者节点。
- ZooKeeper使用一个变种的两阶段提交协议来复制事务给跟随者。当领导者收到来自客户端的变化更新时，它生成一个带有序列号c和领导者纪元e（见定义）的事务，并将该事务发送给所有跟随者。跟随者将该事务添加到其历史队列中，并将ACK发送给领导者。当领导者收到来自法定人数的ACK时，它会向法定人数发送该事务的COMMIT。接受COMMIT的跟随者将提交该事务，除非c高于其历史队列中的任何序列号。在提交之前，它将等待收到其所有早期交易（未完成交易）的COMMIT。
当领导者崩溃时，节点会执行一个恢复协议，在恢复正常操作之前达成一个共同的一致状态，并建立一个新的领导者来广播状态变化。
要行使领导者的角色，一个节点必须有一个法定的节点的支持。由于节点可以崩溃和恢复，随着时间的推移，可以有多个领导者，事实上，同一个节点可以多次行使节点的角色。
节点的生命周期：每个节点一次执行该协议的一个迭代，在任何时候，一个进程都可以放弃当前的迭代，通过进入第0阶段开始新的迭代。
第0阶段 - 潜在领导人的选举
第1阶段 - 发现
第2阶段 - 同步
第3阶段--广播
阶段1和2对于使集合达到相互一致的状态非常重要，特别是在从崩溃中恢复的时候。
## 第一阶段 - 发现
在这个阶段，追随者与他们的潜在领导者进行沟通，这样领导者就会收集其追随者所接受的最新交易的信息。这个阶段的目的是发现在法定人数中接受的最新交易序列，并建立一个新的纪元，使以前的领导者不能提交新的建议。因为追随者的法定人数拥有前一个领导者所接受的所有变化--那么它承诺在当前法定人数中至少有一个追随者在其历史队列中拥有前一个领导者所接受的所有变化，这意味着新的领导者也会拥有这些变化。第一阶段的确切算法可在此获得。
## 第二阶段 - 同步
同步阶段结束了协议的恢复部分，使用领导者在发现阶段更新的历史来同步集群中的副本。领导与追随者进行沟通，从其历史中提出交易。如果追随者自己的历史在领导者的历史后面，追随者会确认这些提议。当领导者看到来自法定人数的确认时，它会向他们发出一个提交消息。在这一点上，领导者被认为是成立的，而不再是前瞻性的。第二阶段的确切算法可在此获得。
## 第三阶段 - 广播
如果没有崩溃发生，对等体就会无限期地停留在这个阶段，一旦有ZooKeeper客户端发出写请求，就进行事务广播。 第3阶段的确切算法请见这里。
为了检测故障，**Zab在跟随者和他们的领导者之间采用了定期的心跳信息**。**如果一个领导者在给定的超时时间内没有收到来自法定追随者的心跳**，它就会放弃其领导地位，转入状态选举和第0阶段。 **如果一个追随者在超时时间内没有收到其领导者的心跳，它也会转入领导者选举阶段**。
引用:
[https://distributedalgorithm.wordpress.com/2015/06/20/architecture-of-zab-zookeeper-atomic-broadcast-protocol/][1]
[https://marcoserafini.github.io/papers/zab.pdf][2]

[1]:	https://distributedalgorithm.wordpress.com/2015/06/20/architecture-of-zab-zookeeper-atomic-broadcast-protocol/
[2]:	https://marcoserafini.github.io/papers/zab.pdf